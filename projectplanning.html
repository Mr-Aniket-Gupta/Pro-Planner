<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Planner Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <style>
      body { font-family: 'Inter', sans-serif; }
      .fc { background: transparent; }
      /* FullCalendar custom theme */
      .fc .fc-toolbar-title { color: #2563eb; font-weight: 800; letter-spacing: 0.5px; font-size: 1.05rem; }
      .fc .fc-button-primary { background: linear-gradient(90deg,#3b82f6,#2563eb); border: none; border-radius: 0.5rem; font-weight: 600; box-shadow: 0 2px 8px #dbeafe; font-size: 0.95em; padding: 0.25rem 0.7rem; }
      .fc .fc-button-primary:not(:disabled):hover { background: linear-gradient(90deg,#2563eb,#1d4ed8); }
      .fc .fc-daygrid-day.fc-day-today { background: #dbeafe; border-radius: 0.5rem; box-shadow: 0 0 0 2px #3b82f6; }
      .fc .fc-daygrid-day-number { color: #2563eb; font-weight: 700; font-size: 0.95em; padding: 0.1em 0.2em; }
      .fc .fc-daygrid-event { background: linear-gradient(90deg,#3b82f6,#2563eb); color: #fff; border-radius: 0.5rem; border: none; font-size: 0.85em; font-weight: 500; box-shadow: 0 2px 8px #dbeafe; padding: 0.1em 0.3em; margin: 1px 0; }
      .fc .fc-col-header-cell { background: #eff6ff; color: #2563eb; font-weight: 700; border-radius: 0.5rem; font-size: 0.95em; letter-spacing: 0.5px; padding: 0.2em 0; }
      .fc .fc-scrollgrid { border-radius: 0.75rem; overflow: hidden; }
      .fc .fc-daygrid-day:hover { background: #bae6fd; transition: background 0.2s; box-shadow: 0 0 0 2px #60a5fa; }
      .fc .fc-highlight { background: #93c5fd !important; }
      .fc .fc-daygrid-day-frame { padding: 0.18rem 0.05rem; }
      .fc .fc-daygrid-day-top { justify-content: center; }
      .fc .fc-daygrid-day { font-size: 0.93em; }
      .fc .fc-daygrid-day.fc-day-today .fc-daygrid-day-number { color: #1d4ed8; font-weight: 900; }
      .fc .fc-daygrid-day.fc-day-today { border: 2px solid #3b82f6; }
      .fc .fc-daygrid-day.fc-day-selected { background: #2563eb22; border-radius: 0.75rem; }
      /* Calendar focus effect */
      #calendarContainer { padding: 1.5rem 0.5rem 1rem 0.5rem; box-shadow: 0 2px 16px #dbeafe; border-radius: 1.25rem; border: 1.5px solid #bfdbfe; transition: box-shadow 0.2s, border 0.2s; }
      #calendarContainer:focus-within { box-shadow: 0 0 0 4px #3b82f6; border-color: #3b82f6; }
      @media (max-width: 600px) {
        #calendarContainer { padding: 0.5rem 0.1rem 0.5rem 0.1rem; }
        .fc .fc-toolbar-title { font-size: 1rem; }
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-white min-h-screen">
    <!-- Header -->
    <header class="flex items-center justify-between px-4 py-4 md:px-10 bg-white shadow-sm sticky top-0 z-10">
      <div class="flex items-center gap-2">
        <svg width="32" height="32" fill="none" viewBox="0 0 32 32"><rect width="32" height="32" rx="8" fill="#3B82F6"/><path d="M10 22l6-12 6 12" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="text-2xl font-extrabold text-blue-600 tracking-tight">Project Planner</span>
      </div>
      <div class="flex items-center gap-4">
        <span class="hidden md:inline text-gray-500 font-medium">Hello, User</span>
        <img src="https://i.pravatar.cc/40?img=3" alt="User" class="w-10 h-10 rounded-full border-2 border-blue-100 shadow" />
        <button onclick="logoutUser()" title="Logout" class="ml-2 px-3 py-2 rounded-xl bg-blue-100 hover:bg-blue-200 text-blue-600 font-semibold flex items-center gap-1 transition">
          <svg width="18" height="18" fill="none" viewBox="0 0 18 18"><path d="M7 13l-1.5-1.5M7 5l-1.5 1.5M3 9h8m0 0l-2-2m2 2l-2 2" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="hidden md:inline">Logout</span>
        </button>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-2 md:px-8 py-8 flex flex-col gap-8">
      <!-- Top Section: Projects + Project Details -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Projects Card -->
        <section class="bg-white rounded-2xl shadow-lg p-6 flex flex-col gap-4 border border-blue-50">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold text-blue-600 flex items-center gap-2">
              <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><rect width="20" height="20" rx="5" fill="#DBEAFE"/><path d="M6 14l4-8 4 8" stroke="#3B82F6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              Projects
            </h2>
            <button onclick="showProjectForm()" class="bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-full p-2 transition" title="Add Project">
              <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" stroke="#3B82F6" stroke-width="1.5"/><path d="M10 6v8M6 10h8" stroke="#3B82F6" stroke-width="1.5" stroke-linecap="round"/></svg>
            </button>
          </div>
          <ul id="projectList" class="space-y-2 max-h-64 overflow-y-auto"></ul>
          <div id="emptyProjectState" class="text-center text-gray-400 py-8">
            <svg class="mx-auto mb-2" width="40" height="40" fill="none" stroke="currentColor"><circle cx="20" cy="20" r="18" stroke-width="2"/><path d="M10 20h20M20 10v20" stroke-width="2"/></svg>
            <div>No projects yet</div>
          </div>
        </section>
        <!-- Project Details Card -->
        <section class="md:col-span-2 bg-white rounded-2xl shadow-lg p-6 flex flex-col gap-4 border border-blue-50" id="projectDetailsCard" style="display:none;">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold text-blue-600 flex items-center gap-2">
              <svg width="20" height="20" fill="none" viewBox="0 0 20 20"><rect width="20" height="20" rx="5" fill="#DBEAFE"/><path d="M6 14l4-8 4 8" stroke="#3B82F6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <span id="projectTitle">Project Name</span>
            </h2>
            <button onclick="editProject()" class="bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-full p-2 transition" title="Edit Project">
              <svg width="18" height="18" fill="none" viewBox="0 0 18 18"><path d="M3 12.75V15h2.25l6.62-6.62a1.5 1.5 0 00-2.12-2.12L3 12.75z" stroke="#3B82F6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14.25 5.25a1.5 1.5 0 00-2.12-2.12l-1.13 1.13a1.5 1.5 0 002.12 2.12l1.13-1.13z" stroke="#3B82F6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </div>
          <div class="text-gray-700 mb-2" id="projectDesc">Project description...</div>
          <div class="flex flex-wrap gap-4">
            <div class="bg-blue-50 rounded-xl px-4 py-2 text-blue-700 text-sm font-medium" id="projectBasic">Basic: -</div>
            <div class="bg-blue-50 rounded-xl px-4 py-2 text-blue-700 text-sm font-medium" id="projectAdvanced">Advanced: -</div>
          </div>
        </section>
      </div>

      <!-- Task Management + Dashboard -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8" id="mainTaskDashboard">
        <!-- Task Management Card -->
        <section class="md:col-span-2 bg-white rounded-2xl shadow-lg p-6 flex flex-col gap-4 border border-blue-50" id="taskSection">
          <div class="flex flex-col md:flex-row md:items-end gap-4 mb-2">
            <input type="text" id="taskInput" placeholder="New Task" class="border border-blue-100 p-3 rounded-xl bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-200 flex-1" />
            <select id="taskTag" class="border border-blue-100 p-3 rounded-xl bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-200">
              <option value="General">General</option>
              <option value="Frontend">Frontend</option>
              <option value="Backend">Backend</option>
              <option value="Bug">Bug</option>
            </select>
            <button onclick="addTask()" class="bg-gradient-to-r from-blue-400 to-blue-600 text-white px-4 py-2 rounded-xl font-semibold shadow hover:from-blue-500 hover:to-blue-700 transition flex-shrink-0">Add Task</button>
          </div>
          <div class="flex gap-2 mb-2">
            <input type="text" id="taskSearch" placeholder="Search tasks..." class="border border-blue-100 p-3 rounded-xl bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-200 flex-1" oninput="renderTasks(this.value, document.getElementById('taskTagFilter').value)" />
            <select id="taskTagFilter" onchange="renderTasks(document.getElementById('taskSearch').value, this.value)" class="border border-blue-100 p-3 rounded-xl bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-200">
              <option value="">All Tags</option>
              <option value="General">General</option>
              <option value="Frontend">Frontend</option>
              <option value="Backend">Backend</option>
              <option value="Bug">Bug</option>
            </select>
          </div>
          <ul id="taskList" class="space-y-2 mb-2"></ul>
          <div id="emptyTaskState" class="text-center text-gray-400 py-8">
            <svg class="mx-auto mb-2" width="40" height="40" fill="none" stroke="currentColor"><rect x="8" y="16" width="24" height="12" rx="4" stroke-width="2"/><path d="M16 22h8M20 18v8" stroke-width="2"/></svg>
            <div>No tasks found</div>
          </div>
        </section>
        <!-- Dashboard Overview Card -->
        <section class="bg-white rounded-2xl shadow-lg p-6 flex flex-col gap-6 border border-blue-50 relative overflow-hidden" id="dashboardSection">
          <div class="flex items-center gap-2 mb-2">
            <svg width="24" height="24" fill="none" viewBox="0 0 24 24"><rect width="24" height="24" rx="6" fill="#DBEAFE"/><path d="M8 17l4-8 4 8" stroke="#3B82F6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span class="font-bold text-blue-600 text-lg">Dashboard</span>
            <span id="dashboardProjectChip" class="ml-auto bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-semibold flex items-center gap-1"><svg width="16" height="16" fill="none" viewBox="0 0 16 16"><circle cx="8" cy="8" r="7" stroke="#3B82F6" stroke-width="1.5"/><path d="M8 4v4l2 2" stroke="#3B82F6" stroke-width="1.5" stroke-linecap="round"/></svg><span id="dashboardProjectName">-</span></span>
          </div>
          <div class="flex flex-col gap-4">
            <div class="flex flex-col items-center gap-2">
              <div class="relative flex items-center justify-center mb-2" style="width:140px;height:140px;">
                <div style="width:120px;height:120px;display:flex;align-items:center;justify-content:center;position:relative;">
                  <svg width="120" height="120" style="transform:rotate(-90deg);display:block;">
                    <circle cx="60" cy="60" r="50" stroke="#E5E7EB" stroke-width="10" fill="none" />
                    <circle id="progressRing" cx="60" cy="60" r="50" stroke="#3B82F6" stroke-width="10" fill="none" stroke-linecap="round" stroke-dasharray="314.16" stroke-dashoffset="314.16" />
                  </svg>
                  <div style="position:absolute;top:0;left:0;width:120px;height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                    <span id="progressPercent" class="text-3xl font-extrabold text-blue-600">0%</span>
                    <div class="text-sm text-gray-400">Complete</div>
                  </div>
                </div>
              </div>
              <div class="flex gap-4 text-sm justify-center">
                <span id="totalTasks" class="font-medium text-gray-700 flex items-center gap-1"><svg width="16" height="16" fill="none" viewBox="0 0 16 16"><rect width="16" height="16" rx="4" fill="#F3F4F6"/><path d="M4 8h8" stroke="#3B82F6" stroke-width="1.5" stroke-linecap="round"/></svg> Total: 0</span>
                <span id="completedTasks" class="font-medium text-green-500 flex items-center gap-1"><svg width="16" height="16" fill="none" viewBox="0 0 16 16"><rect width="16" height="16" rx="4" fill="#D1FAE5"/><path d="M5 8l2 2 4-4" stroke="#10B981" stroke-width="1.5" stroke-linecap="round"/></svg> Done: 0</span>
                <span id="pendingTasks" class="font-medium text-yellow-500 flex items-center gap-1"><svg width="16" height="16" fill="none" viewBox="0 0 16 16"><rect width="16" height="16" rx="4" fill="#FEF3C7"/><path d="M8 4v4l2 2" stroke="#F59E42" stroke-width="1.5" stroke-linecap="round"/></svg> Pending: 0</span>
              </div>
            </div>
            <div class="bg-blue-50 rounded-xl p-4 shadow-inner">
              <h3 class="font-semibold text-blue-500 mb-2 flex items-center gap-1"><svg width="18" height="18" fill="none" viewBox="0 0 18 18"><rect width="18" height="18" rx="4" fill="#DBEAFE"/><path d="M5 13l4-8 4 8" stroke="#3B82F6" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg> Task Analytics</h3>
              <canvas id="taskChart" height="120"></canvas>
              <div class="mt-4">
                <h4 class="text-blue-400 font-semibold text-sm mb-1">Daily Completed Tasks Trend</h4>
                <canvas id="lineChart" height="80"></canvas>
              </div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow border border-blue-100">
              <h3 class="font-semibold text-blue-500 mb-2 flex items-center gap-1"><svg width="18" height="18" fill="none" viewBox="0 0 18 18"><rect width="18" height="18" rx="4" fill="#DBEAFE"/><path d="M5 13l4-8 4 8" stroke="#3B82F6" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg> Calendar</h3>
              <div id="calendarContainer" class="bg-blue-50 rounded-xl shadow-inner p-2 border border-blue-100 focus-within:ring-2 focus-within:ring-blue-300 transition-all">
                <div id="calendar"></div>
              </div>
            </div>
          </div>
        </section>
      </div>
      <div id="selectProjectMsg" class="text-center text-blue-400 text-lg font-semibold py-16 hidden">
        <svg class="mx-auto mb-4" width="48" height="48" fill="none" stroke="#3B82F6"><rect x="8" y="16" width="32" height="20" rx="4" stroke-width="2"/><path d="M16 24h16M24 20v8" stroke-width="2"/></svg>
        Please select a project to manage tasks.
      </div>
    </main>

    <!-- Project Modal (hidden by default) -->
    <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md relative">
        <button onclick="closeProjectForm()" class="absolute top-3 right-3 text-gray-400 hover:text-blue-500">
          <svg width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M6 6l12 12M6 18L18 6" stroke="#3B82F6" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <h2 class="text-xl font-bold text-blue-600 mb-4" id="projectModalTitle">Add Project</h2>
        <form id="projectFormEl" class="space-y-4">
          <input type="text" id="projectName" placeholder="Project Name" class="w-full border border-blue-100 p-3 rounded-xl bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-200" required />
          <textarea id="projectDescInput" placeholder="Project Description" class="w-full border border-blue-100 p-3 rounded-xl bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-200" required></textarea>
          <div>
            <label class="block text-blue-500 font-semibold mb-1">Basic Requirements</label>
            <div id="basicInputs" class="space-y-2">
              <input type="text" class="w-full border border-blue-100 p-3 rounded-xl bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-200 basic-input" placeholder="Basic Requirement" />
            </div>
            <button type="button" onclick="addBasicInput()" class="mt-2 text-xs text-blue-500 hover:underline">+ Add More</button>
          </div>
          <div>
            <label class="block text-blue-500 font-semibold mb-1">Advanced Features</label>
            <div id="advancedInputs" class="space-y-2">
              <input type="text" class="w-full border border-blue-100 p-3 rounded-xl bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-200 advanced-input" placeholder="Advanced Feature" />
            </div>
            <button type="button" onclick="addAdvancedInput()" class="mt-2 text-xs text-blue-500 hover:underline">+ Add More</button>
          </div>
          <button type="submit" class="bg-gradient-to-r from-blue-400 to-blue-600 text-white px-4 py-2 rounded-xl font-semibold shadow hover:from-blue-500 hover:to-blue-700 transition w-full">Save Project</button>
        </form>
      </div>
    </div>

    <script>
      // Data
      let projects = JSON.parse(localStorage.getItem('projects') || '[]');
      let selectedProjectIndex = null;
      let taskList = JSON.parse(localStorage.getItem('tasks') || '[]');

      // Project List Render
      function renderProjectList() {
        const projectListEl = document.getElementById('projectList');
        projectListEl.innerHTML = '';
        if (projects.length === 0) {
          document.getElementById('emptyProjectState').style.display = '';
        } else {
          document.getElementById('emptyProjectState').style.display = 'none';
          projects.forEach((project, idx) => {
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between bg-blue-50 rounded-xl px-4 py-2 hover:bg-blue-100 cursor-pointer transition';
            li.innerHTML = `<span class="font-semibold text-blue-700">${project.name}</span>
              <button onclick="selectProject(${idx})" class="ml-2 text-blue-400 hover:text-blue-600" title="Select"><svg width="18" height="18" fill="none" viewBox="0 0 18 18"><circle cx="9" cy="9" r="8" stroke="#3B82F6" stroke-width="1.5"/><path d="M6 9l2 2 4-4" stroke="#3B82F6" stroke-width="1.5" stroke-linecap="round"/></svg></button>`;
            projectListEl.appendChild(li);
          });
        }
      }

      // Project Details Render
      function renderProjectDetails() {
        if (selectedProjectIndex === null || !projects[selectedProjectIndex]) {
          document.getElementById('projectDetailsCard').style.display = 'none';
          document.getElementById('mainTaskDashboard').style.display = 'none';
          document.getElementById('selectProjectMsg').style.display = '';
          if (calendar && typeof calendar.destroy === 'function') { calendar.destroy(); calendar = null; }
          if (window.taskChart && typeof window.taskChart.destroy === 'function') { window.taskChart.destroy(); window.taskChart = null; }
          if (window.lineChart && typeof window.lineChart.destroy === 'function') { window.lineChart.destroy(); window.lineChart = null; }
          return;
        }
        const project = projects[selectedProjectIndex];
        document.getElementById('projectDetailsCard').style.display = '';
        document.getElementById('mainTaskDashboard').style.display = '';
        document.getElementById('selectProjectMsg').style.display = 'none';
        document.getElementById('projectTitle').innerText = project.name;
        document.getElementById('projectDesc').innerText = project.desc;
        document.getElementById('projectBasic').innerHTML = '<b>Basic:</b> ' + (Array.isArray(project.basic) ? '<ul class="list-disc ml-5">' + project.basic.map(b => `<li>${b}</li>`).join('') + '</ul>' : project.basic || '-');
        document.getElementById('projectAdvanced').innerHTML = '<b>Advanced:</b> ' + (Array.isArray(project.advanced) ? '<ul class="list-disc ml-5">' + project.advanced.map(a => `<li>${a}</li>`).join('') + '</ul>' : project.advanced || '-');
        document.getElementById('dashboardProjectName').innerText = project.name;
        document.getElementById('dashboardProjectChip').title = project.created ? 'Created: ' + new Date(project.created).toLocaleDateString() : '';
        // Calendar/Chart re-render (reliable)
        requestAnimationFrame(() => {
          updateChart();
          renderCalendar();
        });
      }

      // Project Modal
      function showProjectForm(edit = false) {
        document.getElementById('projectModal').classList.remove('hidden');
        document.getElementById('projectModalTitle').innerText = edit ? 'Edit Project' : 'Add Project';
        const basicDiv = document.getElementById('basicInputs');
        const advDiv = document.getElementById('advancedInputs');
        basicDiv.innerHTML = '';
        advDiv.innerHTML = '';
        if (edit && selectedProjectIndex !== null) {
          const p = projects[selectedProjectIndex];
          document.getElementById('projectName').value = p.name;
          document.getElementById('projectDescInput').value = p.desc;
          (Array.isArray(p.basic) ? p.basic : [p.basic]).filter(Boolean).forEach(val => addBasicInput(val));
          (Array.isArray(p.advanced) ? p.advanced : [p.advanced]).filter(Boolean).forEach(val => addAdvancedInput(val));
        } else {
          document.getElementById('projectFormEl').reset();
          addBasicInput();
          addAdvancedInput();
        }
      }
      function closeProjectForm() {
        document.getElementById('projectModal').classList.add('hidden');
      }
      function editProject() {
        showProjectForm(true);
      }
      document.getElementById('projectFormEl').addEventListener('submit', function (e) {
        e.preventDefault();
        const name = document.getElementById('projectName').value;
        const desc = document.getElementById('projectDescInput').value;
        const basic = Array.from(document.querySelectorAll('.basic-input')).map(i => i.value).filter(Boolean);
        const advanced = Array.from(document.querySelectorAll('.advanced-input')).map(i => i.value).filter(Boolean);
        if (document.getElementById('projectModalTitle').innerText === 'Edit Project' && selectedProjectIndex !== null) {
          projects[selectedProjectIndex] = { name, desc, basic, advanced, created: new Date() };
        } else {
          projects.push({ name, desc, basic, advanced, created: new Date() });
          selectedProjectIndex = projects.length - 1;
        }
        localStorage.setItem('projects', JSON.stringify(projects));
        renderProjectList();
        renderProjectDetails();
        closeProjectForm();
      });
      function selectProject(idx) {
        selectedProjectIndex = idx;
        renderProjectDetails();
        renderTasks();
      }

      // Task List Render
      function renderTasks(filter = '', tag = '') {
        const taskUl = document.getElementById('taskList');
        taskUl.innerHTML = '';
        let filtered = taskList.filter(task =>
          (selectedProjectIndex === null || task.project === projects[selectedProjectIndex]?.name) &&
          task.text.toLowerCase().includes(filter.toLowerCase()) &&
          (tag === '' || task.tag === tag)
        );
        if (filtered.length === 0) {
          document.getElementById('emptyTaskState').style.display = '';
        } else {
          document.getElementById('emptyTaskState').style.display = 'none';
        }
        filtered.forEach((task, index) => {
          const li = document.createElement('li');
          li.className = 'flex items-center justify-between bg-blue-50 rounded-xl px-4 py-2 shadow-sm';
          li.innerHTML = `
            <div class="flex items-center gap-2">
              <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${index})" class="accent-blue-500">
              <span class="${task.completed ? 'line-through text-gray-400' : 'text-gray-700 font-medium'}">${task.text}</span>
              <span class="text-xs text-blue-400 ml-2">[${task.tag}]</span>
            </div>
            <div class="flex gap-2">
              <button onclick="editTask(${index})" class="text-yellow-400 hover:text-yellow-500 transition rounded-lg px-2" title="Edit">✏️</button>
              <button onclick="deleteTask(${index})" class="text-red-400 hover:text-red-500 transition rounded-lg px-2" title="Delete">✖</button>
            </div>
          `;
          taskUl.appendChild(li);
        });
        updateDashboard();
        updateChart();
      }
      function addTask() {
        const input = document.getElementById('taskInput');
        const tag = document.getElementById('taskTag').value;
        if (input.value.trim() && selectedProjectIndex !== null) {
          taskList.push({ text: input.value.trim(), completed: false, tag, created: new Date(), project: projects[selectedProjectIndex].name });
          saveTasks();
          renderTasks();
          input.value = '';
        }
      }
      function toggleTask(index) {
        taskList[index].completed = !taskList[index].completed;
        saveTasks();
        renderTasks();
      }
      function deleteTask(index) {
        taskList.splice(index, 1);
        saveTasks();
        renderTasks();
      }
      function editTask(index) {
        const task = taskList[index];
        Swal.fire({
          title: 'Edit Task',
          html: `<input id="swalTaskText" class="swal2-input" value="${task.text}">
                 <select id="swalTaskTag" class="swal2-input">
                   <option value="General" ${task.tag==='General'?'selected':''}>General</option>
                   <option value="Frontend" ${task.tag==='Frontend'?'selected':''}>Frontend</option>
                   <option value="Backend" ${task.tag==='Backend'?'selected':''}>Backend</option>
                   <option value="Bug" ${task.tag==='Bug'?'selected':''}>Bug</option>
                 </select>` ,
          focusConfirm: false,
          preConfirm: () => {
            return {
              text: document.getElementById('swalTaskText').value,
              tag: document.getElementById('swalTaskTag').value
            }
          }
        }).then(result => {
          if(result.isConfirmed) {
            taskList[index].text = result.value.text;
            taskList[index].tag = result.value.tag;
            saveTasks();
            renderTasks();
          }
        });
      }
      function saveTasks() {
        localStorage.setItem('tasks', JSON.stringify(taskList));
      }
      function updateDashboard() {
        const filtered = taskList.filter(task => selectedProjectIndex === null || task.project === projects[selectedProjectIndex]?.name);
        document.getElementById('totalTasks').innerText = `Total: ${filtered.length}`;
        document.getElementById('completedTasks').innerText = `Done: ${filtered.filter(t => t.completed).length}`;
        document.getElementById('pendingTasks').innerText = `Pending: ${filtered.filter(t => !t.completed).length}`;
        // Progress Ring
        const total = filtered.length;
        const done = filtered.filter(t => t.completed).length;
        const percent = total ? Math.round((done / total) * 100) : 0;
        document.getElementById('progressPercent').innerText = percent + '%';
        const ring = document.getElementById('progressRing');
        const circleLen = 2 * Math.PI * 50;
        ring.setAttribute('stroke-dasharray', circleLen);
        ring.setAttribute('stroke-dashoffset', circleLen - (circleLen * percent / 100));
        ring.style.transition = 'stroke-dashoffset 0.6s cubic-bezier(.4,2,.6,1)';
      }
      function updateChart() {
        const filtered = taskList.filter(task => selectedProjectIndex === null || task.project === projects[selectedProjectIndex]?.name);
        const completedData = {};
        const pendingData = {};
        filtered.forEach(task => {
          const date = new Date(task.created).toLocaleDateString();
          if (!completedData[date]) completedData[date] = 0;
          if (!pendingData[date]) pendingData[date] = 0;
          if (task.completed) completedData[date]++;
          else pendingData[date]++;
        });
        const labels = Object.keys(completedData);
        const completed = labels.map(label => completedData[label]);
        const pending = labels.map(label => pendingData[label]);
        const chartCanvas = document.getElementById('taskChart');
        if (!chartCanvas) return;
        if (window.taskChart && typeof window.taskChart.destroy === 'function') { window.taskChart.destroy(); window.taskChart = null; }
        const ctx = chartCanvas.getContext('2d');
        window.taskChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: 'Completed', data: completed, backgroundColor: '#34D399' },
              { label: 'Pending', data: pending, backgroundColor: '#FBBF24' },
            ],
          },
        });
        // Line Chart for daily completed tasks
        const dailyCompleted = {};
        filtered.forEach(task => {
          const date = new Date(task.created).toLocaleDateString();
          if (!dailyCompleted[date]) dailyCompleted[date] = 0;
          if (task.completed) dailyCompleted[date]++;
        });
        const lineLabels = Object.keys(dailyCompleted);
        const lineData = lineLabels.map(label => dailyCompleted[label]);
        const lineCanvas = document.getElementById('lineChart');
        if (!lineCanvas) return;
        if (window.lineChart && typeof window.lineChart.destroy === 'function') { window.lineChart.destroy(); window.lineChart = null; }
        const lineCtx = lineCanvas.getContext('2d');
        window.lineChart = new Chart(lineCtx, {
          type: 'line',
          data: {
            labels: lineLabels,
            datasets: [{
              label: 'Completed Tasks',
              data: lineData,
              borderColor: '#3B82F6',
              backgroundColor: 'rgba(59,130,246,0.1)',
              fill: true,
              tension: 0.4,
              pointRadius: 4,
              pointBackgroundColor: '#3B82F6',
            }],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false } },
              y: { beginAtZero: true, grid: { color: '#E5E7EB' } }
            }
          }
        });
      }
      document.getElementById('taskSearch').addEventListener('input', function() {
        renderTasks(this.value, document.getElementById('taskTagFilter').value);
      });
      document.getElementById('taskTagFilter').addEventListener('change', function() {
        renderTasks(document.getElementById('taskSearch').value, this.value);
      });
      // Calendar
      function renderCalendar() {
        if (calendar && typeof calendar.destroy === 'function') { calendar.destroy(); calendar = null; }
        calendarEl = document.getElementById('calendar');
        if (!calendarEl) return;
        // Calendar focus on click
        calendarEl.addEventListener('click', function() {
          document.getElementById('calendarContainer').focus();
        });
        const filtered = taskList.filter(task => selectedProjectIndex === null || task.project === projects[selectedProjectIndex]?.name);
        const events = filtered.map(task => ({
          title: task.text,
          start: new Date(task.created).toISOString().split('T')[0]
        }));
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          events
        });
        calendar.render();
      }
      document.addEventListener('DOMContentLoaded', function () {
        renderProjectList();
        renderProjectDetails();
        document.getElementById('mainTaskDashboard').style.display = 'none';
        document.getElementById('selectProjectMsg').style.display = '';
        renderTasks();
        renderCalendar();
      });
      // Add More for Basic/Advanced
      function addBasicInput(val = '') {
        const div = document.createElement('div');
        div.className = 'flex gap-2';
        div.innerHTML = `<input type="text" class="w-full border border-blue-100 p-3 rounded-xl bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-200 basic-input" placeholder="Basic Requirement" value="${val}"><button type="button" onclick="this.parentNode.remove()" class="text-red-400 hover:text-red-600 px-2">✖</button>`;
        document.getElementById('basicInputs').appendChild(div);
      }
      function addAdvancedInput(val = '') {
        const div = document.createElement('div');
        div.className = 'flex gap-2';
        div.innerHTML = `<input type="text" class="w-full border border-blue-100 p-3 rounded-xl bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-200 advanced-input" placeholder="Advanced Feature" value="${val}"><button type="button" onclick="this.parentNode.remove()" class="text-red-400 hover:text-red-600 px-2">✖</button>`;
        document.getElementById('advancedInputs').appendChild(div);
      }
      function logoutUser() {
        localStorage.clear();
        location.reload();
      }
    </script>
  </body>
</html>
